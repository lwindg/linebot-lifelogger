# Data Model: Google Sheets 表格結構

**Date**: 2025-11-15 | **Plan**: [plan.md](./plan.md)

本文件定義 Google Sheets 中的資料結構、欄位規格和命名規則。

---

## 1. 試算表總覽

### 1.1 試算表結構

```
LINE Bot LifeLogger (試算表名稱)
├── 2025-11 (子表單/工作表)
├── 2025-12 (子表單/工作表)
├── 2026-01 (子表單/工作表)
└── ...
```

### 1.2 命名規則

**試算表名稱**: 由使用者指定或使用預設名稱
**子表單名稱格式**: `YYYY-MM`
- 範例: `2025-11`, `2025-12`, `2026-01`
- 規則: 4 位數年份 + 連字號 + 2 位數月份（補零）

---

## 2. 月份子表單結構

### 2.1 欄位定義

每個月份子表單包含以下欄位：

| 欄位編號 | 欄位名稱 | 資料類型 | 說明 | 範例 |
|---------|---------|---------|------|------|
| A | 時間 | DateTime String | 訊息接收時間（台灣時區） | `2025-11-15 14:30:25` |
| B | 類型 | String | 訊息類型 | `文字`, `圖片`, `[不支援]` |
| C | 內容 | Text / Image | 訊息內容或圖片 | `今天天氣很好` / IMAGE 函式 |

### 2.2 表頭格式

**第一列為表頭**（粗體、背景色）:

| A | B | C |
|---|---|---|
| **時間** | **類型** | **內容** |

**格式設定**:
- 字體: 粗體
- 背景色: 淺灰色 (#F3F3F3)
- 文字對齊: 置中
- 凍結第一列（freeze rows）

---

## 3. 資料列格式

### 3.1 一般訊息記錄

**文字訊息範例**:

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-15 14:30:25 | 文字 | 今天天氣很好 |
| 2025-11-15 14:31:10 | 文字 | 準備出門了 |

**圖片訊息範例**:

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-15 14:35:00 | 圖片 | [顯示圖片] |

- 內容欄使用 `=IMAGE("https://drive.google.com/uc?id=FILE_ID")` 函式
- 圖片會自動顯示在儲存格中

**不支援類型範例**:

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-15 14:40:00 | [不支援] | 貼圖訊息 |
| 2025-11-15 14:41:00 | [不支援] | 影片訊息 |

### 3.2 週分界標記

在新的一週（週日）開始時，插入一列特殊標記：

| 時間 | 類型 | 內容 |
|------|------|------|
| **--- 第 47 週 ---** | | |
| 2025-11-16 08:00:00 | 文字 | 早安 |

**週分界列格式**:
- A 欄: `--- 第 {week_number} 週 ---`
- B 欄: 空白
- C 欄: 空白
- 整列背景色: 淺藍色 (#E3F2FD)
- 字體: 粗體
- 文字對齊: 置中（跨三欄合併）

**實際格式** (合併儲存格):
```
A2:C2 (合併) = "--- 第 47 週 ---"
```

### 3.3 錯誤記錄格式

**圖片下載失敗**:

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-15 15:00:00 | 圖片 | [圖片下載失敗] |

**圖片過大**:

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-15 15:05:00 | 圖片 | [圖片過大，無法嵌入] |

- 錯誤訊息使用紅色文字 (#D32F2F)

---

## 4. 儲存格格式規範

### 4.1 欄位格式

| 欄位 | 寬度 | 格式 | 對齊方式 |
|------|------|------|----------|
| A (時間) | 150 px | 文字 | 靠左 |
| B (類型) | 80 px | 文字 | 置中 |
| C (內容) | 500 px | 文字/圖片 | 靠左 |

### 4.2 列高設定

- **一般文字訊息**: 自動高度（依內容調整）
- **圖片訊息**: 固定 200 px（讓圖片完整顯示）
- **週分界標記**: 固定 30 px

### 4.3 圖片顯示設定

使用 Google Sheets 的 `IMAGE` 函式：

```
=IMAGE("圖片URL", 模式)
```

**模式選項**:
- `1`: 調整圖片大小以適應儲存格（保持比例）
- `2`: 拉伸或壓縮圖片以填滿儲存格
- `3`: 保持圖片原始大小
- `4`: 自訂大小

**建議使用**: 模式 `1`（保持比例）

**完整公式範例**:
```
=IMAGE("https://drive.google.com/uc?id=1a2b3c4d5e6f", 1)
```

---

## 5. 資料範例

### 5.1 完整月份範例

**工作表名稱**: `2025-11`

| 時間 | 類型 | 內容 |
|------|------|------|
| **時間** | **類型** | **內容** |
| **--- 第 46 週 ---** | | |
| 2025-11-15 08:30:00 | 文字 | 早安，新的一天開始了 |
| 2025-11-15 09:15:00 | 圖片 | [圖片：早餐照片] |
| 2025-11-15 12:00:00 | 文字 | 午餐時間 🍜 |
| 2025-11-15 14:30:00 | [不支援] | 貼圖訊息 |
| **--- 第 47 週 ---** | | |
| 2025-11-16 08:00:00 | 文字 | 週日早晨 |
| 2025-11-16 10:30:00 | 圖片 | [圖片：風景照] |
| 2025-11-16 15:00:00 | 文字 | 下午茶時光 ☕ |

### 5.2 跨月份範例

**11 月最後一天** (`2025-11` 工作表):

| 時間 | 類型 | 內容 |
|------|------|------|
| 2025-11-30 22:00:00 | 文字 | 11 月的最後一天 |
| 2025-11-30 23:59:00 | 文字 | 晚安 |

**12 月第一天** (`2025-12` 工作表 - 自動建立):

| 時間 | 類型 | 內容 |
|------|------|------|
| **時間** | **類型** | **內容** |
| **--- 第 48 週 ---** | | |
| 2025-12-01 00:05:00 | 文字 | 12 月開始了！ |
| 2025-12-01 08:00:00 | 文字 | 早安 |

---

## 6. 資料操作

### 6.1 新增記錄

**操作**: 使用 `append_row` 在表格最後新增一列

**邏輯**:
1. 計算當前訊息的月份（台灣時區）
2. 檢查對應月份工作表是否存在
   - 存在: 開啟工作表
   - 不存在: 建立新工作表 + 寫入表頭
3. 判斷是否需要插入週分界標記
   - 取得工作表最後一列的時間
   - 計算是否跨週（前一則不是週日，當前是週日）
   - 如果跨週: 插入週分界列
4. 新增訊息記錄列

**Pseudocode**:
```python
def add_message_record(timestamp, msg_type, content):
    # 1. 轉換時間到台灣時區
    taiwan_time = convert_to_taiwan_tz(timestamp)
    month_key = taiwan_time.strftime('%Y-%m')

    # 2. 取得或建立工作表
    worksheet = get_or_create_worksheet(month_key)

    # 3. 檢查是否需要週分界
    if should_add_week_separator(worksheet, taiwan_time):
        week_num = calculate_week_number(taiwan_time)
        insert_week_separator(worksheet, week_num)

    # 4. 新增記錄
    time_str = taiwan_time.strftime('%Y-%m-%d %H:%M:%S')
    worksheet.append_row([time_str, msg_type, content])
```

### 6.2 圖片記錄特殊處理

**圖片訊息流程**:
```python
def add_image_record(timestamp, image_binary_data):
    try:
        # 1. 壓縮圖片
        compressed_image = compress_image(image_binary_data)

        # 2. 上傳到 Google Drive
        file_id = upload_to_drive(compressed_image)

        # 3. 建立 IMAGE 公式
        image_formula = f'=IMAGE("https://drive.google.com/uc?id={file_id}", 1)'

        # 4. 記錄到 Sheets
        add_message_record(timestamp, '圖片', image_formula)

    except DownloadError:
        add_message_record(timestamp, '圖片', '[圖片下載失敗]')

    except SizeError:
        add_message_record(timestamp, '圖片', '[圖片過大，無法嵌入]')
```

### 6.3 週分界標記插入邏輯

```python
def should_add_week_separator(worksheet, current_time):
    """
    判斷是否需要插入週分界標記
    """
    # 取得最後一列資料（排除表頭和週分界列）
    all_values = worksheet.get_all_values()

    if len(all_values) <= 1:  # 只有表頭或空表
        # 第一筆記錄，如果是週日則插入週分界
        return current_time.weekday() == 6

    # 從最後一列往前找，找到第一個訊息記錄（非週分界）
    for row in reversed(all_values[1:]):  # 跳過表頭
        if row[0] and not row[0].startswith('---'):
            # 找到上一則訊息
            previous_time_str = row[0]
            previous_time = parse_taiwan_time(previous_time_str)

            # 判斷跨週: 前一則不是週日(6) 且當前是週日(6)
            if previous_time.weekday() != 6 and current_time.weekday() == 6:
                return True

            return False

    return False  # 找不到前一則訊息，不插入

def insert_week_separator(worksheet, week_number):
    """
    插入週分界標記
    """
    separator_text = f"--- 第 {week_number} 週 ---"

    # 新增週分界列
    worksheet.append_row([separator_text, '', ''])

    # 取得新增列的列號
    row_index = len(worksheet.get_all_values())

    # 格式化週分界列
    # 合併 A:C 儲存格
    worksheet.merge_cells(f'A{row_index}:C{row_index}')

    # 設定格式（需要使用 Google Sheets API）
    # - 背景色: #E3F2FD
    # - 字體: 粗體
    # - 對齊: 置中
```

---

## 7. 資料驗證規則

### 7.1 資料完整性

- **時間欄**: 不可為空，必須符合格式 `YYYY-MM-DD HH:MM:SS`
- **類型欄**: 必須為 `文字`, `圖片`, 或 `[不支援]`
- **內容欄**: 可為空（錯誤情況）

### 7.2 資料一致性

- 同一工作表中的所有時間必須屬於同一個月份
- 時間戳記必須按順序排列（舊到新）
- 週分界標記必須出現在正確位置（週日之前的第一筆記錄）

---

## 8. Google Sheets 設定

### 8.1 試算表權限

**Service Account**:
- Email: `linebot-logger@PROJECT_ID.iam.gserviceaccount.com`
- Role: Editor（可讀寫試算表）

**使用者**:
- 擁有者或編輯者（可手動檢視和編輯）

### 8.2 試算表設定建議

- **啟用通知**: 否（避免每次記錄都發通知）
- **版本歷程**: 保留（可回溯變更）
- **自動儲存**: 啟用（Google Sheets 預設）

---

## 9. 資料模型總結

### 9.1 關鍵決策

| 決策項目 | 決策結果 | 理由 |
|---------|---------|------|
| 子表單命名 | `YYYY-MM` | 簡潔易讀，易於排序 |
| 欄位數量 | 3 欄（時間、類型、內容） | MVP 最簡設計 |
| 圖片儲存 | Drive + IMAGE 函式 | 確保長期可存取性 |
| 週分界格式 | 獨立列 + 合併儲存格 | 視覺上明顯，易於實作 |
| 週起始日 | 週日 | 符合需求釐清結果 |
| 時間格式 | `YYYY-MM-DD HH:MM:SS` | ISO 8601 標準，可排序 |

### 9.2 擴展性考量

**未來可能擴展**（P2/P3）:
- 新增「使用者」欄（支援多使用者）
- 新增「標籤」欄（分類訊息）
- 新增「位置」欄（記錄地理位置）
- 統計摘要子表單（月度統計）

**保持向後相容**:
- 新增欄位時使用 `append` 而非 `insert`
- 維持 A、B、C 欄的基本結構不變

---

**資料模型版本**: 1.0.0
**建立日期**: 2025-11-15
**下一步**: 定義 API 合約 (`api-contracts.md`)
